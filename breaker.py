# ------------------------------------------------------------------------------
# Imports
# ------------------------------------------------------------------------------
import sys
import re
import argparse
import pandas as pd

# ------------------------------------------------------------------------------
# Init
# ------------------------------------------------------------------------------

tfile = "data/perks.txt"
xfile = "data/perks.xlsx"

pd.set_option("display.width", 0)
pd.set_option("display.max_rows", 20)
pd.set_option("display.max_columns", 10)

# ------------------------------------------------------------------------------
# ------------------------------------------------------------------------------
parser = argparse.ArgumentParser()
parser.add_argument("-d",  dest="direction",  type=str, default="push", help="either 'pull' or 'push'...'pull' goes from the excel to text, 'push' goes from text to excel")
parser.add_argument("-t",  dest="tfile",      type=str, default=tfile,  help="path to the text source file")
parser.add_argument("-x",  dest="xfile",      type=str, default=xfile,  help="path to the excel source file")

args = parser.parse_args()

# ------------------------------------------------------------------------------
# Main
# ------------------------------------------------------------------------------
def main():
    # --------------------------------------------------------------------------
    # Start
    # --------------------------------------------------------------------------
    print("Starting...")

    # --------------------------------------------------------------------------
    # Get the text data and transform it to a data frame
    # --------------------------------------------------------------------------
    tdata = parse_text_file(args.tfile)

    # --------------------------------------------------------------------------
    # Get the spreadsheet version of the data
    # --------------------------------------------------------------------------
    #xdata = pd.read_excel(args.xfile, sheet_name="abilities", header=[0,2], index_col=0, engine="openpyxl")

    # --------------------------------------------------------------------------
    # Save the spreadsheet version
    # --------------------------------------------------------------------------
    if args.direction == "push":
        tdata.to_excel(xfile, sheet_name="abilities")

    # --------------------------------------------------------------------------
    # Finish
    # --------------------------------------------------------------------------
    print("...Finished!")

# ------------------------------------------------------------------------------
# Parse out the text file
# ------------------------------------------------------------------------------
def parse_text_file(tfile):
    # --------------------------------------------------------------------------
    # Start
    # --------------------------------------------------------------------------
    print("...reading marked up text source...")

    # --------------------------------------------------------------------------
    # Get the text data out of the file and hold it as a list
    # --------------------------------------------------------------------------
    fdata = open(tfile, "r", encoding="utf-8").read().splitlines()

    # --------------------------------------------------------------------------
    # Work through it and catalog things at the perk level
    # --------------------------------------------------------------------------
    perks = []
    perk = {}
    for i, line in enumerate(fdata):
        # ----------------------------------------------------------------------
        # Trim whitespace
        # ----------------------------------------------------------------------
        line = line.strip()

        # ----------------------------------------------------------------------
        # Skip blank lines
        # ----------------------------------------------------------------------
        if len(line) == 0:
            continue

        # ----------------------------------------------------------------------
        # Section headers, just skip for now
        # ----------------------------------------------------------------------
        if line.startswith("/"):
            continue

        # ----------------------------------------------------------------------
        # When we hit a new perk
        # ----------------------------------------------------------------------
        if line.startswith("----"):
            # ------------------------------------------------------------------
            # Add the previous perk to the list if it's there
            # ------------------------------------------------------------------
            if perk:
                perks.append(perk)

            # ------------------------------------------------------------------
            # Start a new perk
            # ------------------------------------------------------------------
            perk = {}
            pname, pdesc = line[5:].split(":",1)
            perk[("Ability", "Name")] = pname.strip()
            perk[("Ability", "Desc")] = pdesc.strip()

        # ----------------------------------------------------------------------
        # When we hit an alias tag
        # ----------------------------------------------------------------------
        elif line.startswith("="):
            perk[("Ability", "Alias")] = re.sub("^=+","",line).strip()

        # ----------------------------------------------------------------------
        # When we hit a source tag
        # ----------------------------------------------------------------------
        elif line.startswith(":"):
            tag = re.sub("^#+","",line).strip()
            perk[("Source", tag)] = "x"

        # ----------------------------------------------------------------------
        # When we hit a dependency tag
        # ----------------------------------------------------------------------
        elif line.startswith("#"):
            tag = re.sub("^#+","",line).strip()
            perk[("Dependency", tag)] = "x"

        # ----------------------------------------------------------------------
        # When we hit a theme tag
        # ----------------------------------------------------------------------
        elif line.startswith("*"):
            tag = re.sub("^\*+","",line).strip()
            perk[("Theme", tag)] = "x"

        # ----------------------------------------------------------------------
        # When we hit a character tag
        # ----------------------------------------------------------------------
        elif line.startswith("@"):
            tag = re.sub("^@+","",line).strip()
            perk[("Character", tag)] = "x"

        # ----------------------------------------------------------------------
        # When we have hit the last line
        # ----------------------------------------------------------------------
        if i == len(fdata)-1:
            perks.append(perk)

    # --------------------------------------------------------------------------
    # Make that into a dataframe
    # --------------------------------------------------------------------------
    tdata = pd.DataFrame(perks)
    tdata.columns = pd.MultiIndex.from_tuples(tdata.columns)
    tdata = tdata.sort_index(axis=1)

    # --------------------------------------------------------------------------
    # Finish
    # --------------------------------------------------------------------------
    return tdata

# ------------------------------------------------------------------------------
# Run
# ------------------------------------------------------------------------------
if __name__ == "__main__":
    main()
